#context("correctness of TREC")
library(TREC)

test_that("combineClusterings result is exactly the way we construct this algorithm", {
data<-read.table(file = "data_mix_gaussian.txt")
m<-100
n<-3*m
####### Generating clusters via K means with 10 random starts #######
#
#
# 1) k =3
#
#
######

#random starts
nRestarts <- 4
nMethods <- nRestarts
k <- 3

#
#  Get the clusterings from k-means
set.seed(100)
branchComponent <- combineClusterings(kmeans(data,centers = 3),kmeans(data,centers = 4),kmeans(data,centers = 5))
expected <- matrix(data = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
                            ,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                            2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA
                            ,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,1,NA,NA,NA,NA,NA,NA,NA,NA,1,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,1,1,1,2,1,2,1,2,1,1,2,2,2,1,1,2,2,2,2,2,1,2,1,1,2,1,1,1,2,1,1,2,2,2,1,2,2,2,2,1,1,1,2,1,1,2,1,1,1,2,1,1,2,1,1,1,1,1,
                            1,2,1,1,2,1,1,1,1,2,1,2,1,2,1,2,2,1,1,2,1,1,1,2,1,1,1,2,2,2,2,1,2,2,1,2,2,1,2,2,1,2,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA
                            ,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA,NA),nrow = 300, ncol = 2)
colnames(expected) <- paste("Level", 1:ncol(expected))
labels <- paste("object", 1:nrow(expected))
rownames(expected) <- labels
expect_equal(branchComponent$tree,expected)
####### Generating clusters via K means with 10 random starts #######
#
#
# 2) k = 16
#
#
######

#random starts
nRestarts <- 10
nMethods <- nRestarts
k <- 16
set.seed(1000)

branchComponent <- combineClusterings(kmeans(data,centers = 15),kmeans(data,centers = 16),kmeans(data,centers = 17))
expected<-matrix(data = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,  
                          1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,  
                          2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,5,1,6,6,7,8,5,9,8,8,6,8,10,5,9,6,1,5,8,5,9,1,6,5,1,10,10,9,7,7,9,7,10,8,8,6,1,8,8,5,8,10,9,7,1,9,1,6,1,5,7,10,9,5,9,10,8  
                          ,7,5,9,6,7,6,5,1,9,6,9,5,10,7,9,9,5,6,1,11,6,9,1,6,5,7,1,10,6,8,5,5,10,1,9,5,8,5,5,6,5,10,5,11,2,2,3,2,12,11,13,11,2,13,3,12,2,2,13,3,13,13,12,4,2,2,2,3,13,11,2,2,11,2,12,2,12,4,3,3,12,3,2,11,11,12,2,4,13,4,14,4,13,14,2,12,4,2,14,11,11,11,
                          13,4,14,3,14,11,2,14,13,11,2,2,12,11,12,13,13,14,12,11,14,14,3,2,14,11,13,13,3,13,2,13,13,14,13,2,11,3,13,4,13,15,16,16,16,15,15,15,15,16,15,15,16,15,16,15,16,16,15,16,15,15,15,15,16,16,16,16,16,16,16,16,16,16,15,16,15,16,15,16,16,16,15,15,
                          15,16,16,15,16,16,15,15,15,16,15,15,16,15,16,16,16,16,16,15,16,15,16,16,15,16,15,15,16,16,15,15,15,15,16,16,15,15,16,15,15,16,16,15,16,15,16,15,15,16,16,15,16,16,16,15,15,1,NA,2,3,4,5,6,7,5,8,3,5,9,6,7,3,NA,6,5,1,10,NA,2,6,NA,9,11,10,12,4,10,12,
                          9,5,5,2,NA,5,5,13,5,9,10,14,NA,7,NA,2,NA,6,14,9,7,6,7,9,5,12,13,10,3,4,2,1,NA,10,3,7,6,11,12,7,10,6,2,NA,NA,2,10,NA,3,13,14,NA,9,2,8,6,6,9,NA,10,6,5,1,6,3,6,9,6,NA,NA,NA,NA,NA,15,NA,16,NA,NA,16,NA,15,NA,NA,17,NA,17,16,18,NA,NA,NA,NA,NA,16,19,NA,NA,NA,NA,18,NA,15,NA,NA,NA,18,  
                          NA,NA,19,NA,18,NA,NA,17,NA,20,NA,17,21,NA,15,NA,NA,21,NA,NA,19,16,NA,20,NA,21,NA,NA,21,16,19,NA,NA,15,NA,18,17,16,20,15,NA,20,20,NA,NA,21,19,16,16,NA,17,NA,16,17,21,17,NA,NA,NA,16,NA,16,22,23,23,24,22,25,25,26,23,22,22,27,28,23,26,24,27,25,27,25,26,28,25,27,24,24,24,
                          27,23,24,NA,23,24,22,27,28,23,22,24,23,24,26,22,28,24,23,25,24,23,22,26,25,24,25,25,24,22,24,24,24,23,24,22,23,22,24,24,25,24,26,25,24,23,25,28,25,22,23,23,28,26,27,25,28,24,27,28,24,26,27,28,28,27,27,25,27,24,27,22,22),nrow=300,ncol=3)
colnames(expected) <- paste("Level", 1:ncol(expected))
labels <- paste("object", 1:nrow(expected))
rownames(expected) <- labels
expect_equal(branchComponent$tree,expected)
####### Combining K means (k=2) with Gaussian model based #######
#
######
nMethods <- 2
k <- 3
branchComponent <- combineClusterings(stats::hclust(dist(data),method = "single"),stats::hclust(dist(data),method = "complete"))
expected <- matrix(data = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
                            ,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                            2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
                            ,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                            2,2,2,2,2,2,2,NA,2,2,2,2,2,3,2,2,2,2,2,2,2,2,NA,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,NA,2,2,2,2,2,2,2,2,NA,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,NA,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,1,4,4,4,4,4,4,4,4
                            ,4,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,NA,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,4,1,4,6,6,6,6,6,6,6,NA,6,6,6,6,6,6,7,6,6,6,6,6,NA,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,6,6,6,6,6,6,6,6,NA,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
                            6,6,6,6,6,6,6,6,6),nrow = 300,ncol = 3)
colnames(expected) <- paste("Level", 1:ncol(expected))
labels <- paste("object", 1:nrow(expected))
rownames(expected) <- labels
expect_equal(branchComponent$tree[,1:3],expected)
})

test_that("combineClusterings work for vector or matrix input as well",{

data<-read.table(file = "data_mix_gaussian.txt")
m<-100
n<-3*m
####### test whether matrix input works for combineClusterings ###########
#
# one input is matrix output of single linkage
# the other input is output of complete linkage
nMethods <- 2
clusteringMatrix <- mergeToMatrix(stats::hclust(dist(data),method = "single")$merge)
branchComponent <- combineClusterings(clusteringMatrix,stats::hclust(dist(data),method = "complete"))
expected <- matrix(data = c(1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1
                            ,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                            2,2,2,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,3,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3
                            ,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,
                            2,2,2,2,2,2,2,NA,2,2,2,2,2,3,2,2,2,2,2,2,2,2,NA,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,2,2,2,2,2,2,2,2,NA,2,2,2,2,2,2,2,2,NA,2,2,2,2,2,2,2,2,2,2,2,2,2,2,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,NA,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,1,4,4,4,4,4,4,4,4
                            ,4,1,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,NA,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,4,4,4,4,4,4,4,4,4,4,4,4,4,4,5,4,1,4,6,6,6,6,6,6,6,NA,6,6,6,6,6,6,7,6,6,6,6,6,NA,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,7,6,6,6,6,6,6,6,6,NA,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,
                            6,6,6,6,6,6,6,6,6),nrow = 300,ncol = 3)
colnames(expected) <- paste("Level", 1:ncol(expected))
labels <- paste("object", 1:nrow(expected))
rownames(expected) <- labels
expect_equal(branchComponent$tree[,1:3],expected)
})


test_that("getClusteringDistance can work, and work correctly", {
data<-read.table(file = "data_mix_gaussian.txt")
m<-100
n<-3*m
####### Generating clusters via K means with 2 random starts #######
#
#
# 1) k =3
#
#
######
  
#random starts
nRestarts <- 2
nMethods <- nRestarts
k <- 3
seeds <- c(220478, 990173)
#
#  Get the clusterings from k-means
set.seed(seeds[1])
kMean1 <- kmeans(data,centers=k,iter.max=15)
set.seed(seeds[2])
kMean2 <- kmeans(data,centers=k+1, iter.max = 15)
distance <- clusDist(kMean1,kMean2)
expect_equal(floor(distance[1]),0)
####### Generating clusters via K means with 10 random starts #######
#
#
# 2) k = 16
#
#
######
  
#random starts
nRestarts <- 2
nMethods <- nRestarts
k <- 16
seeds <- c(220478, 990173)

set.seed(seeds[1])
kMean1 <- kmeans(data,centers=k,iter.max=15)
set.seed(seeds[2])
kMean2 <- kmeans(data,centers=k+1, iter.max = 15)
distance <- clusDist(kMean1,kMean2)
expect_equal(floor(distance[1]),0)
####### Combining K means (k=2) with Gaussian model based #######
#
######
nMethods <- 2
k <- 2
kMean <- kmeans(data,centers=k,iter.max=15)
require(mclust)
mClust <- Mclust(data)

distance <- clusDist(kMean,mClust)
expect_equal(floor(distance[1]),0)
})

